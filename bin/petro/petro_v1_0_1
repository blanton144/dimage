#!/usr/bin/env python

# Create v1_0_1 file with Petrosian quantities in it.
#
# Mike Blanton, NYU 2015-10-02

import pdb
import os
import sys
import re
import numpy as np
import fitsio
import dimage.path as path

dpath = path.Path()

# Notes: 
# NSAID is NSA_ID in drpAll
# Why is Z -> NSA_REDSHIFT?
# PETROTH50 is PETRO_TH50 in drpAll, same with EL
# PETROTH90 is PETRO_TH90 in drpAll, same with EL
# How crazy would it be to remove _EL and 
#   call all of these EPETRO?
# ABSMAG in drpAll is Sersic -> needs documented, or removed
# AMIVAR in drpAll is Sersic -> needs documented, or removed
# MSTAR in drpAll is Sersic MASS -> needs documented or removed
# MSTAR_EL in drpAll is PETRO_MASS_EL -> needs documented or removed

petro_dtype = np.dtype([('PETRO_BA_EL', np.float32),
                        ('PETRO_PHI_EL', np.float32),
                        ('PETROFLUX_R_EL', np.float32),
                        ('PETROFLUX_IVAR_R_EL', np.float32),
                        ('PETROTHETA_R_EL', np.float32),
                        ('PETROTH50_R_EL', np.float32),
                        ('PETROTH90_R_EL', np.float32),
                        ('PETROTHETA_EL', np.float32),
                        ('PETROFLUX_EL', np.float32, (7,)),
                        ('PETROFLUX_IVAR_EL', np.float32, (7,)),
                        ('PETROTH50_EL', np.float32, (7,)),
                        ('PETROTH90_EL', np.float32, (7,)),
                        ('APCORR_R_EL', np.float32),
                        ('APCORR_EL', np.float32, (7,)),
                        ('APCORR_SELF_EL', np.float32, (7,)),
                        ])

kpetro_dtype = np.dtype([('PETRO_NMGY_EL', np.float32, (7,)),
                         ('PETRO_NMGY_IVAR_EL', np.float32, (7,)),
                         ('PETRO_OK_EL', np.int16),
                         ('PETRO_RNMGY_EL', np.float32, (7,)),
                         ('PETRO_ABSMAG_EL', np.float32, (7,)),
                         ('PETRO_AMIVAR_EL', np.float32, (7,)),
                         ('PETRO_KCORRECT_EL', np.float32, (7,)),
                         ('PETRO_KCOEFF_EL', np.float32, (5,)),
                         ('PETRO_MASS_EL', np.float32),
                         ('PETRO_MTOL_EL', np.float32, (7,)),
                         ('PETRO_B300_EL', np.float32),
                         ('PETRO_B1000_EL', np.float32),
                         ('PETRO_METS_EL', np.float32)])

dr7flag_dtype = np.dtype([('IN_DR7_LSS', np.int8)])


def replace_dtype_name(dtype, oldname, newname):
    nn = list(dtype.names)
    ireplace = np.nonzero(np.array(nn) == oldname)[0][0]
    nn[ireplace] = newname
    dtype.names = tuple(nn)


def main(argv):
    old_version = 'v1_0_0'
    new_version = 'v1_0_1'

    nsafile = dpath.get('nsa', version='v1_0_0')
    newfile = os.path.basename(re.sub(old_version, new_version, nsafile))
    nsa = fitsio.read(nsafile)
    new_dtype = nsa.dtype

    petrofile = os.path.join(os.getenv('ATLAS_DATA'), 'test', 'petro',
                             'petro_v1_0_0_a3.fits')
    petro = fitsio.read(petrofile)

    kpetrofile = os.path.join(os.getenv('ATLAS_DATA'), 'test', 'petro',
                              'petro_kcorrect_v1_0_0_a3.fits')
    kpetro = fitsio.read(kpetrofile)

    dr7flagfile = os.path.join(os.getenv('ATLAS_DATA'), 'test', 'petro',
                               'nsa_v1_0_0_dr7flag.fits')
    dr7flag = fitsio.read(dr7flagfile)

    # Construct new dtype:
    # - replace old quantities
    replace_dtype_name(new_dtype, 'NMGY', 'SERSIC_NMGY')
    replace_dtype_name(new_dtype, 'NMGY_IVAR', 'SERSIC_NMGY_IVAR')
    replace_dtype_name(new_dtype, 'OK', 'SERSIC_OK')
    replace_dtype_name(new_dtype, 'RNMGY', 'SERSIC_RNMGY')
    replace_dtype_name(new_dtype, 'ABSMAG', 'SERSIC_ABSMAG')
    replace_dtype_name(new_dtype, 'AMIVAR', 'SERSIC_AMIVAR')
    replace_dtype_name(new_dtype, 'KCORRECT', 'SERSIC_KCORRECT')
    replace_dtype_name(new_dtype, 'KCOEFF', 'SERSIC_KCOEFF')
    replace_dtype_name(new_dtype, 'MASS', 'SERSIC_MASS')
    replace_dtype_name(new_dtype, 'MTOL', 'SERSIC_MTOL')
    replace_dtype_name(new_dtype, 'B300', 'SERSIC_B300')
    replace_dtype_name(new_dtype, 'B1000', 'SERSIC_B1000')
    replace_dtype_name(new_dtype, 'METS', 'SERSIC_METS')

    # - append elliptical petro quantities
    new_dtype_descr = new_dtype.descr
    new_dtype_descr.extend(petro_dtype.descr)
    new_dtype_descr.extend(kpetro_dtype.descr)
    new_dtype_descr.extend(dr7flag_dtype.descr)
    new_dtype = np.dtype(new_dtype_descr)

    # Create new structure
    new_nsa = np.zeros(nsa.shape, dtype=new_dtype)
    for name in nsa.dtype.names:
        new_nsa[name] = nsa[name]
    for name in petro_dtype.names:
        pname = re.sub('(_EL)', '', name).lower()
        if(name == 'PETRO_BA_EL'):
            pname = 'ba'
        if(name == 'PETRO_PHI_EL'):
            pname = 'phi'
        if(name == 'PETROFLUX_IVAR_EL'):
            pname = 'petroivar'
        if(name == 'PETROFLUX_IVAR_R_EL'):
            pname = 'petroivar_r'
        new_nsa[name] = petro[pname]
    for name in kpetro_dtype.names:
        kname = re.sub('(_EL)', '', name)
        kname = re.sub('(PETRO_?)', '', kname)
        new_nsa[name] = kpetro[kname]
    new_nsa['IN_DR7_LSS'] = dr7flag
    new_nsa['PETRO_PHI_EL'] = 180. - new_nsa['PETRO_PHI_EL']

    # Write out file
    fitsio.write(newfile, new_nsa, clobber=True)


if __name__ == "__main__":
    try:
        main(sys.argv[1:])
    except:
        import sys
        tb = sys.exc_info()[2]
        pdb.post_mortem(tb)
