#!/usr/local/bin/perl

#
# Query for and eventually retrieve 
# and Montage request
#
# MRB 2009-03-04 (based on getWiki)
#

if(!$ARGV[1]) {
	print "Usage: retrieveMontage <reqid> <local name>\n";
	exit;
}

$reqid= $ARGV[0];
$filename= $ARGV[1];

$done=0;
$iter=0;
$maxiter=30;
while($done == 0 && ($iter < $maxiter || $line eq "MONTAGE STATUS: NEW\n")) {
	print "Checking montage site ...\n";
	open(fp,"checkMontage $reqid|");
	$line= <fp>;
	if($line=~/MONTAGE STATUS/) {
		print $line;
	} else {
		while(<fp>) {
			chop;
			if(/status=\"end\"/) {
				/resulthtml=\"(.*)\/index.html\" msgurl/;
				$htmlbase=$1;
				$done=1;
			}
		}
	}
	close(fp);
	if($line eq "MONTAGE STATUS: NOT SUBMITTED\n") {
		exit;
	}
	if($line eq "MONTAGE STATUS: ERROR\n") {
		exit;
	}
	if($line eq "MONTAGE STATUS: ABORT\n") {
		exit;
	}
	if(!$done) {
		sleep 8;
	}

	$iter++;
}

if($htmlbase) {
	system("curl $htmlbase/mosaic.fits > $filename");
}

system("cancelMontage $reqid");
